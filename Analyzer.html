<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Advanced CSV Analyzer</title>

<!-- PapaParse (CSV parsing) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root {
        --bg: #f4f4f4;
        --fg: #000;
        --card: white;
        --table-header: #333;
        --table-header-text: white;
    }
    body.dark {
        --bg: #1d1d1d;
        --fg: #eee;
        --card: #2a2a2a;
        --table-header: #555;
        --table-header-text: #eee;
    }

    body {
        background: var(--bg);
        color: var(--fg);
        font-family: Arial, sans-serif;
        margin: 20px;
        transition: 0.3s;
    }
    .container {
        background: var(--card);
        padding: 20px;
        border-radius: 10px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    th, td {
        border: 1px solid #777;
        padding: 8px;
    }
    th {
        background: var(--table-header);
        color: var(--table-header-text);
    }

    .highlight {
        background: #ffb3b3 !important;
    }

    select, input, button {
        padding: 6px;
        margin: 5px;
    }
    #darkToggle {
        float: right;
        margin-bottom: 10px;
    }
</style>
</head>

<body>
<div class="container">

    <button id="darkToggle" onclick="toggleDarkMode()">ðŸŒ™ Toggle Dark Mode</button>
    <h2>Advanced CSV Analyzer</h2>

    <p>Upload any CSV to analyze, detect anomalies, filter data, and visualize.</p>

    <input type="file" id="csvFile" accept=".csv">

    <hr>

    <h3>Filter Data</h3>
    <label>Column:</label>
    <select id="filterColumn"></select>

    <label>Condition:</label>
    <select id="filterCondition">
        <option value="contains">contains</option>
        <option value="=">=</option>
        <option value=">">></option>
        <option value="<"><</option>
    </select>

    <label>Value:</label>
    <input type="text" id="filterValue">

    <button onclick="applyFilter()">Apply</button>
    <button onclick="resetFilter()">Reset</button>

    <hr>

    <h3>Data Table</h3>
    <button onclick="downloadAnomalies()">Download Anomalies as CSV</button>
    <div id="tableContainer"></div>

    <hr>

    <h3>Column Statistics</h3>
    <div id="statsContainer"></div>

    <hr>

    <h3>Visualization</h3>

    <p><strong>1. Line Chart</strong></p>
    <select id="chartColumn"></select>
    <button onclick="drawLineChart()">Draw Line Chart</button>

    <p><strong>2. Histogram</strong></p>
    <select id="histColumn"></select>
    <button onclick="drawHistogram()">Draw Histogram</button>

    <p><strong>3. Scatter Plot</strong></p>
    <label>X-Axis:</label>
    <select id="scatterX"></select>

    <label>Y-Axis:</label>
    <select id="scatterY"></select>

    <button onclick="drawScatter()">Draw Scatter Plot</button>

    <div>
        <canvas id="chartCanvas"></canvas>
    </div>

</div>

<script>
let rawData = [];
let headers = [];
let numericColumns = [];
let chart;
let anomalyRows = [];

document.getElementById("csvFile").addEventListener("change", function () {
    Papa.parse(this.files[0], {
        header: true,
        dynamicTyping: true,
        complete: function (results) {
            rawData = results.data;
            headers = results.meta.fields;
            detectNumericColumns();
            populateDropdowns();
            detectAnomalies();
            displayTable(rawData);
            computeStats();
        }
    });
});

// ------------- DARK MODE ----------------
function toggleDarkMode() {
    document.body.classList.toggle("dark");
}

// ------------- COLUMN DETECTION ----------
function detectNumericColumns() {
    numericColumns = headers.filter(h =>
        rawData.some(r => !isNaN(r[h]) && r[h] !== "")
    );
}

// ------------- DROPDOWNS -------------------
function populateDropdowns() {
    let selects = [
        "filterColumn", "chartColumn", "histColumn",
        "scatterX", "scatterY"
    ];

    selects.forEach(id => {
        document.getElementById(id).innerHTML = "";
    });

    headers.forEach(h => {
        document.getElementById("filterColumn").innerHTML += `<option>${h}</option>`;
        if (numericColumns.includes(h)) {
            document.getElementById("chartColumn").innerHTML += `<option>${h}</option>`;
            document.getElementById("histColumn").innerHTML += `<option>${h}</option>`;
            document.getElementById("scatterX").innerHTML += `<option>${h}</option>`;
            document.getElementById("scatterY").innerHTML += `<option>${h}</option>`;
        }
    });
}

// ------------- ANOMALY DETECTION -----------
function detectAnomalies() {
    anomalyRows = [];

    numericColumns.forEach(col => {
        let values = rawData.map(r => r[col]).filter(v => !isNaN(v));
        let mean = values.reduce((a,b)=>a+b,0) / values.length;
        let sd = Math.sqrt(values.map(v => (v - mean) ** 2).reduce((a,b)=>a+b) / values.length);

        rawData.forEach((row, i) => {
            let v = row[col];
            if (isNaN(v)) return;

            let z = (v - mean) / sd;

            if (Math.abs(z) > 3 || Math.abs(v - mean) > 2 * sd) {
                if (!anomalyRows.includes(i)) anomalyRows.push(i);
            }
        });
    });
}

// ------------- DOWNLOAD ANOMALIES ----------
function downloadAnomalies() {
    let rows = anomalyRows.map(i => rawData[i]);
    let csv = Papa.unparse(rows);

    let blob = new Blob([csv], { type: "text/csv" });
    let url = URL.createObjectURL(blob);

    let a = document.createElement("a");
    a.href = url;
    a.download = "anomalies.csv";
    a.click();
}

// ------------- TABLE DISPLAY ---------------
function displayTable(data) {
    let html = "<table><tr>";
    headers.forEach(h => html += `<th>${h}</th>`);
    html += "</tr>";

    data.forEach((row, i) => {
        let highlight = anomalyRows.includes(i) ? "highlight" : "";
        html += `<tr class="${highlight}">`;
        headers.forEach(h => html += `<td>${row[h] ?? ""}</td>`);
        html += "</tr>";
    });

    html += "</table>";
    document.getElementById("tableContainer").innerHTML = html;
}

// ------------- STATS -----------------------
function computeStats() {
    let html = "";

    numericColumns.forEach(col => {
        let values = rawData.map(r => r[col]).filter(v => !isNaN(v));
        values.sort((a,b)=>a-b);

        let mean = values.reduce((a,b)=>a+b,0) / values.length;
        let min = values[0];
        let max = values[values.length - 1];
        let median = values[Math.floor(values.length / 2)];
        let sd = Math.sqrt(values.map(v => (v - mean) ** 2).reduce((a,b)=>a+b) / values.length);

        html += `
            <p><strong>${col}</strong><br>
            Count: ${values.length}<br>
            Mean: ${mean.toFixed(3)}<br>
            Median: ${median}<br>
            Min: ${min}<br>
            Max: ${max}<br>
            Std Dev: ${sd.toFixed(3)}</p>
        `;
    });

    document.getElementById("statsContainer").innerHTML = html;
}

// ------------- FILTERING --------------------
function applyFilter() {
    let col = filterColumn.value;
    let condition = filterCondition.value;
    let val = filterValue.value;

    let filtered = rawData.filter(row => {
        let cell = row[col];

        if (condition === "contains") return String(cell).includes(val);
        if (condition === "=") return cell == val;
        if (condition === ">") return parseFloat(cell) > parseFloat(val);
        if (condition === "<") return parseFloat(cell) < parseFloat(val);
    });

    displayTable(filtered);
}

function resetFilter() {
    displayTable(rawData);
}

// ------------- CHARTS -----------------------
function drawLineChart() {
    let col = chartColumn.value;
    let values = rawData.map(r => r[col]).filter(v => !isNaN(v));
    makeChart("line", col, values);
}

function drawHistogram() {
    let col = histColumn.value;
    let values = rawData.map(r => r[col]).filter(v => !isNaN(v));

    // Build bins
    let bins = 10;
    let min = Math.min(...values);
    let max = Math.max(...values);
    let width = (max - min) / bins;

    let counts = Array(bins).fill(0);

    values.forEach(v => {
        let index = Math.min(bins - 1, Math.floor((v - min) / width));
        counts[index]++;
    });

    let labels = Array.from({length: bins}, (_, i) => 
        (min + i*width).toFixed(1)
    );

    makeChart("bar", col + " Histogram", counts, labels);
}

function drawScatter() {
    let xCol = scatterX.value;
    let yCol = scatterY.value;

    let points = rawData
        .filter(r => !isNaN(r[xCol]) && !isNaN(r[yCol]))
        .map(r => ({x: r[xCol], y: r[yCol]}));

    if (chart) chart.destroy();

    chart = new Chart(document.getElementById("chartCanvas"), {
        type: "scatter",
        data: {
            datasets: [{
                label: `${xCol} vs ${yCol}`,
                data: points,
                borderWidth: 2
            }]
        }
    });
}

function makeChart(type, label, values, labels=null) {
    if (chart) chart.destroy();

    chart = new Chart(document.getElementById("chartCanvas"), {
        type: type,
        data: {
            labels: labels || values.map((_, i) => i + 1),
            datasets: [{
                label: label,
                data: values,
                borderWidth: 2,
                fill: false
            }]
        }
    });
}
</script>
</body>
</html>
